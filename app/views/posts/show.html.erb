<div class="card text-muted">
  <div class="card-body">
    <h2 class="card-title"><%= @post.title %></h2>
    <div class="my-4 d-flex gap-1">
      <% if current_user == @post.user %>
        <%= link_to t('edit_btn'), edit_post_path(@post), class: 'btn btn-primary', data: { turbo: false } %>
        <%= button_to t('publish_btn'), publish_post_path(@post), method: :patch,
          class: 'btn btn-primary', data: { turbo: false } if @post.scheduled? %>
        <%= Post.human_attribute_name @post.status %>
      <% else %>
        <%= link_to t('reports.report_btn'), new_report_path(reportable: @post, reportable_type: @post.class), class: 'btn btn-secondary btn-sm' %>
      <% end %>
    </div>

    <h6 class="card-subtitle mb-2">
      <%= link_to t('.authored_by', author_name: @post.user.full_name), @post.user.profile %>
    </h6>

    <p class="card-text"><%= @post.content %></p>

    <% if @post.draft? %>
      <p class="card-subtitle mb-2">
        <time datetime="<%= @post.created_at.to_date %>">
          <%= date_fixer(@post) %> <%= I18n.l(@post.created_at.to_datetime, format: :long) %>
        </time>
      </p>
    <% else %>
      <p class="card-subtitle mb-2">
        <time datetime="<%= @post.published_at ? @post.published_at.to_datetime : @post.created_at.to_datetime %>">
          <%= date_fixer(@post) %> <%= I18n.l(@post.published_at ? @post.published_at.to_datetime : @post.created_at.to_datetime, format: :long) %>
        </time>
      </p>
    <% end %>
    <p>
      <time datetime="<%= @post.edited_at.to_date %>">
        <%= t('.last_update', update_date: I18n.l(@post.edited_at.to_datetime, format: :long)) %>
      </time>
    </p>

    <p class="card-subtitle mb-2 text-body-secondary tags">
      <% @post.tags.each do |tag| %>
        <%= link_to "##{tag.name}", searches_path(query: "##{tag.name}"), class: 'text-decoration-none' %>
      <% end %>
    </p>

    <div class="btn-group">
      <div class="me-2 mt-2">
        <%= @likes_count %> <%= Like.model_name.human(count: @likes_count) %>
      </div>
      <% if @liked %>
        <%= button_to post_like_path(@post, @liked), method: :delete, class: 'btn btn-sm', id: 'unlike' do %>
          <%= image_tag 'thumbs-up-solid', width: '20rem' %>
        <% end %>
      <% else %>
        <%= button_to post_likes_path(@post), method: :post, class: 'btn btn-sm', id: 'like' do %>
          <%= image_tag 'thumbs-up-regular', width: '20rem' %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<%= form_with model: [@post, @comment] , method: :post, class: 'mt-3' do |form| %>
  <%= form.text_area :message, placeholder: (Comment.human_attribute_name :message), class:"form-control" %>
  <%= form.submit t('comments.comment_btn'), class:"btn btn-primary mt-2" %>
<% end %>


<div id="comments", class="card mt-3 mb-3 text-muted">
  <div class="card-header">
    <%= @post.comments.count %> <%= Comment.model_name.human(count: @post.comments.count) %>
  </div>
  <% @post.comments.each do |comment| %>
    <div class="card-body comment" id="<%= dom_id(comment) %>">
      <% if comment.removed?%>
        <p><%= t('comments.removed_content') %> </p>
      <% else %>
        <blockquote class="blockquote mb-0">
          <p><%= comment.message %></p>
          <footer class="blockquote-footer">
            <%= link_to comment.user.full_name, comment.user.profile %> <%= '(autor)' if comment.user == @post.user %>
          </footer>
        </blockquote>

        <% if comment.user.deleted_at.nil? %>
          <div class="btn-group flex-column">
            <div class="d-flex">
              <div class="mt-2 me-2">
                <%= comment.likes.count %> <%= Like.model_name.human(count: comment.likes.count) %>
              </div>

              <div class="me-2">
                <% if user_signed_in? && comment.likes.where(user_id: current_user.id).any? %>
                  <% like = comment.likes.find_by(user_id: current_user.id) %>
                  <%= button_to comment_like_path(comment, like), method: :delete, class: 'btn btn-sm', id: 'unlike' do %>
                        <%= image_tag 'thumbs-up-solid', width: '20rem', class: 'mb-4' %>
                  <% end %>
                <% else %>
                  <%= button_to comment_likes_path(comment), method: :post, class: 'btn btn-sm', id: 'like' do %>
                    <%= image_tag 'thumbs-up-regular', width: '20rem', class: 'mb-2' %>
                  <% end %>
                <% end %>
              </div>
            </div>

            <% if current_user != comment.user %>
              <div class="report-link-wrapper">
                <%= link_to t('reports.report_btn'), new_report_path(reportable: comment, reportable_type: comment.class), class: 'btn btn-secondary btn-sm' %>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>

<script>
  document.addEventListener('turbo:load', () => {
    if (window.location.pathname === "/posts/<%= @post.id%>")  {
      const anchor_tag = window.location.hash;
      if (anchor_tag) {
        const comment = document.querySelector(anchor_tag);
        if (comment) {
          comment.classList.add('highlighted');
          setTimeout(function() {
            comment.classList.remove('highlighted');
          }, 4000);
        }
      }
    };
  });
</script>
